name: 360安全路由2 P3 OpenWrt 云编译

on:
  repository_dispatch:
  workflow_dispatch:
    inputs:
      ssh:
        description: 'SSH connection to Actions'
        required: false
        default: 'false'
  schedule:
    - cron: 0 9 * * *

jobs:
  build:
    runs-on: ubuntu-latest
    if: github.event.repository.owner.id == github.event.sender.id
    
    steps:
    - name: 检查项目分支
      uses: actions/checkout@main

    - name: 初始化环境
      env:
        DEBIAN_FRONTEND: noninteractive
      run: |
        sudo rm -rf /etc/apt/sources.list.d/* /usr/share/dotnet /usr/local/lib/android /opt/ghc
        sudo -E apt-get -qq update
        sudo -E apt-get -qq install $(curl -fsSL https://is.gd/depends_ubuntu_2204) \
          build-essential clang flex bison g++ gawk gcc-multilib g++-multilib gettext git libncurses5-dev \
          libssl-dev python3-distutils rsync unzip zlib1g-dev file wget qemu-utils
        sudo -E apt-get -qq autoremove --purge
        sudo -E apt-get -qq clean
        sudo timedatectl set-timezone Asia/Shanghai

    - name: 克隆源代码
      env:
        REPO_URL: https://github.com/coolsnowwolf/lede
        REPO_BRANCH: master
      run: |
        git clone --depth=1 $REPO_URL -b $REPO_BRANCH openwrt
        ln -sf /usr/bin/python3 openwrt/scripts/config.guess
        ln -sf /usr/bin/python3 openwrt/scripts/diffconfig.sh
        cd openwrt
        useVersionInfo=$(git show -s --date=short --format="Author: %an\nDate: %cd\nCommit: %s\nCommit Hash: %H")
        echo "$useVersionInfo" > versioninfo.txt

    - name: 加载自定义配置
      run: |
        [ -e files ] && mv files openwrt/files
        chmod +x $GITHUB_WORKSPACE/diy-c301.sh
        cd openwrt
        $GITHUB_WORKSPACE/diy-c301.sh
        [ -e $GITHUB_WORKSPACE/configs/c301.config ] && mv $GITHUB_WORKSPACE/configs/c301.config .config
        make defconfig
        ./scripts/diffconfig.sh > diffconfig

    - name: 编译固件
      id: compile
      run: |
        cd openwrt
        echo -e "开始编译360安全路由2 P3 OpenWrt固件..."
        make download -j8
        make -j$(nproc)
        echo "COMPILE_STATUS=success" >> $GITHUB_ENV
        
    - name: 上传固件
      uses: actions/upload-artifact@main
      if: env.COMPILE_STATUS == 'success'
      with:
        name: 360安全路由2 P3 OpenWrt固件
        path: openwrt/bin/targets/*/*/*.gz

    - name: 发布固件
      uses: ncipollo/release-action@v1
      if: env.COMPILE_STATUS == 'success'
      with:
        name: 360安全路由2 P3 OpenWrt 固件
        tag: C301
        artifacts: openwrt/bin/targets/*/*/*.gz
        allowUpdates: true
        token: ${{ secrets.GITHUB_TOKEN }}
        body: |
          360安全路由2 P3 OpenWrt 固件编译
          - 默认IP: 192.168.1.1
          - 默认用户名: root
          - 默认密码: password
          - 集成基本网络功能和常用插件
